<section class="section-spacing" data-section-id="{{ section.id }}" data-section-type="instagram">
  <div class="page-width">
    <header class="section-header text-center">
      <h2 class="section-header__title">{{ section.settings.title | default: 'FOLLOW US ON INSTAGRAM' }}</h2>
      <p>{{ section.settings.subtitle | default: 'Stay connected with our latest updates and community highlights' }}</p>
    </header>
    
    <!-- Instagram Feed Options -->
    <div class="instagram-options">
      {% if section.settings.instagram_username %}
        <!-- Instagram Feed -->
        <div class="instagram-feed" id="instagram-feed-{{ section.id }}">
          <!-- Instagram Basic Display API Feed -->
          <div class="instagram-grid" id="instagram-grid-{{ section.id }}">
            <!-- Photos will be loaded here -->
          </div>
          
          <!-- Loading State -->
          <div class="instagram-loading" id="instagram-loading-{{ section.id }}">
            <div class="loading-spinner"></div>
            <p>Loading Instagram photos...</p>
          </div>
          
          <!-- Error State -->
          <div class="instagram-error" id="instagram-error-{{ section.id }}" style="display: none;">
            <p>Unable to load Instagram photos. Please check your username or try again later.</p>
            <button class="retry-btn" onclick="loadInstagramFeed('{{ section.id }}')">Retry</button>
          </div>
        </div>
        
        <!-- Instagram Profile Link -->
        <div class="instagram-profile-link">
          <a href="https://www.instagram.com/{{ section.settings.instagram_username }}" 
             target="_blank" 
             rel="noopener" 
             class="instagram-follow-btn">
            <span class="icon icon-instagram"></span>
            Follow @{{ section.settings.instagram_username }}
          </a>
        </div>
      {% endif %}
      
      {% if section.settings.instagram_embed_code %}
        <!-- Instagram Embed Code / Instafeed Code -->
        <div class="instagram-embed">
          {{ section.settings.instagram_embed_code }}
        </div>
      {% elsif section.settings.instafeed_code %}
        <!-- Instafeed App Code -->
        <div class="instafeed-container">
          {{ section.settings.instafeed_code }}
        </div>
      {% endif %}
      
      {% unless section.settings.instagram_username or section.settings.instagram_embed_code %}
        <!-- Fallback Social Media Showcase -->
        <div class="social-showcase">
          <div class="social-grid">
            <div class="social-item">
              <div class="social-icon">
                <span class="icon icon-instagram"></span>
              </div>
              <h3>Instagram</h3>
              <p>Follow us for behind-the-scenes content and community highlights</p>
              <a href="#" class="social-link">Coming Soon</a>
            </div>
            
            <div class="social-item">
              <div class="social-icon">
                <span class="icon icon-facebook"></span>
              </div>
              <h3>Facebook</h3>
              <p>Join our community for updates, events, and exclusive offers</p>
              <a href="#" class="social-link">Coming Soon</a>
            </div>
            
            <div class="social-item">
              <div class="social-icon">
                <span class="icon icon-twitter"></span>
              </div>
              <h3>Twitter</h3>
              <p>Stay updated with the latest news and announcements</p>
              <a href="#" class="social-link">Coming Soon</a>
            </div>
          </div>
        </div>
      {% endunless %}
    </div>
    
    <!-- Call to Action -->
    {% if section.settings.show_cta %}
      <div class="instagram-cta">
        <h3>{{ section.settings.cta_title | default: 'Join Our Community' }}</h3>
        <p>{{ section.settings.cta_description | default: 'Connect with fellow e-bike enthusiasts and stay updated with our latest products and news.' }}</p>
        {% if section.settings.cta_button_text and section.settings.cta_button_link %}
          <a href="{{ section.settings.cta_button_link }}" class="btn btn--primary btn--large">
            {{ section.settings.cta_button_text }}
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

<!-- CSS removed to use theme classes
  .instagram-section {
    padding: 3rem 0;
    background: #f8f9fa;
  }
  
  .section-header__divider {
    width: 60px;
    height: 2px;
    background: #E1306C;
    margin: 1rem auto;
  }
  
  .section-header__subtitle {
    font-size: 1rem;
    color: #666;
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.5;
  }
  
  .instagram-options {
    margin: 2rem 0;
  }
  
  .instagram-feed {
    margin: 2rem 0;
  }
  
  .instagram-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .instagram-photo {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 8px;
    background: #f0f0f0;
    transition: transform 0.3s ease;
  }
  
  .instagram-photo:hover {
    transform: scale(1.05);
  }
  
  .instagram-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }
  
  .instagram-photo:hover img {
    opacity: 0.9;
  }
  
  .instagram-photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .instagram-photo:hover .instagram-photo-overlay {
    opacity: 1;
  }
  
  .instagram-photo-overlay .icon {
    color: #ffffff;
    font-size: 1.5rem;
  }
  
  .instagram-loading {
    text-align: center;
    padding: 2rem;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #E1306C;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .instagram-error {
    text-align: center;
    padding: 2rem;
    color: #666;
  }
  
  .retry-btn {
    background: #E1306C;
    color: #ffffff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    margin-top: 1rem;
    transition: background 0.3s ease;
  }
  
  .retry-btn:hover {
    background: #C13584;
  }
  
  .instagram-profile-link {
    text-align: center;
    margin: 2rem 0;
  }
  
  .instagram-follow-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    color: #ffffff;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(220, 39, 67, 0.3);
  }
  
  .instagram-follow-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 39, 67, 0.4);
    color: #ffffff;
  }
  
  .instagram-follow-btn .icon {
    font-size: 1.2rem;
  }
  
  .instagram-embed {
    margin: 2rem 0;
    text-align: center;
  }
  
  .instagram-embed iframe {
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  
  .social-showcase {
    margin: 2rem 0;
  }
  
  .social-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-top: 2rem;
  }
  
  .social-item {
    text-align: center;
    padding: 2rem 1rem;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .social-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  
  .social-icon {
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
  }
  
  .social-icon .icon {
    font-size: 2.5rem;
    color: #E1306C;
  }
  
  .social-icon .icon-facebook {
    color: #1877F2;
  }
  
  .social-icon .icon-twitter {
    color: #1DA1F2;
  }
  
  .social-item h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c2c2c;
    margin-bottom: 0.75rem;
  }
  
  .social-item p {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.4;
    margin-bottom: 1rem;
  }
  
  .social-link {
    display: inline-block;
    background: #E1306C;
    color: #ffffff;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  
  .social-link:hover {
    background: #C13584;
    color: #ffffff;
  }
  
  .instagram-cta {
    text-align: center;
    margin-top: 3rem;
    padding: 2rem;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }
  
  .instagram-cta h3 {
    font-size: 1.4rem;
    font-weight: 600;
    color: #2c2c2c;
    margin-bottom: 0.75rem;
  }
  
  .instagram-cta p {
    font-size: 1rem;
    color: #666;
    line-height: 1.5;
    margin-bottom: 1.5rem;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .btn--large {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }
  
  .btn--primary {
    background: #E1306C;
    color: #ffffff;
    border: 2px solid #E1306C;
  }
  
  .btn--primary:hover {
    background: #C13584;
    border-color: #C13584;
    transform: translateY(-1px);
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .instagram-section {
      padding: 2rem 0;
    }
    
    .instagram-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
    
    .social-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .social-item {
      padding: 1.5rem 1rem;
    }
    
    .instagram-cta {
      margin-top: 2rem;
      padding: 1.5rem;
    }
    
    .instagram-cta h3 {
      font-size: 1.3rem;
    }
    
    .instagram-cta p {
      font-size: 0.9rem;
    }
  }
  
  @media (max-width: 480px) {
    .instagram-grid {
      grid-template-columns: 1fr;
    }
  }
-->

<script>
  // Instagram Feed Loader
  function loadInstagramFeed(sectionId) {
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!section) return;
    
    const grid = section.querySelector('.instagram-grid');
    const loading = section.querySelector('.instagram-loading');
    const error = section.querySelector('.instagram-error');
    const username = grid.dataset.username;
    const count = parseInt(grid.dataset.count) || 6;
    
    if (!username) return;
    
    // Show loading
    loading.style.display = 'block';
    error.style.display = 'none';
    grid.innerHTML = '';
    
    // Method 1: Try using a working Instagram API endpoint
    fetchInstagramPhotos(username, count, grid, loading, error, sectionId);
  }
  
  function fetchInstagramPhotos(username, count, grid, loading, error, sectionId) {
    // Use a more reliable Instagram data source
    const apiUrl = `https://www.instagram.com/${username}/?__a=1&__d=1`;
    
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Instagram API not accessible');
        }
        return response.json();
      })
      .then(data => {
        if (data && data.graphql && data.graphql.user && data.graphql.user.edge_owner_to_timeline_media) {
          const media = data.graphql.user.edge_owner_to_timeline_media.edges;
          renderInstagramPhotos(media.slice(0, count), grid, loading, error);
        } else {
          throw new Error('No media data found');
        }
      })
      .catch(err => {
        console.log('Instagram API failed, trying alternative method...');
        // Fallback: Use a different approach
        fetchInstagramPhotosAlternative(username, count, grid, loading, error, sectionId);
      });
  }
  
  function fetchInstagramPhotosAlternative(username, count, grid, loading, error, sectionId) {
    // Alternative method: Use a different Instagram endpoint
    const alternativeUrl = `https://www.instagram.com/${username}/feed/`;
    
    fetch(alternativeUrl)
      .then(response => response.text())
      .then(html => {
        // Parse the HTML to extract photo data
        const photoMatches = html.match(/https:\/\/[^"]*\.jpg[^"]*/g);
        if (photoMatches && photoMatches.length > 0) {
          const photos = photoMatches.slice(0, count).map(url => ({
            node: {
              thumbnail_src: url,
              shortcode: Math.random().toString(36).substr(2, 9),
              edge_media_to_caption: { edges: [] }
            }
          }));
          renderInstagramPhotos(photos, grid, loading, error);
        } else {
          throw new Error('No photos found in HTML');
        }
      })
      .catch(err => {
        console.log('Alternative method failed, showing placeholders...');
        renderInstagramPlaceholders(count, grid, loading, error);
      });
  }
  
  function renderInstagramPhotos(media, grid, loading, error) {
    loading.style.display = 'none';
    error.style.display = 'none';
    
    let html = '';
    media.forEach(photo => {
      const imageUrl = photo.node.thumbnail_src;
      const postUrl = `https://www.instagram.com/p/${photo.node.shortcode}`;
      const caption = photo.node.edge_media_to_caption.edges.length > 0 
        ? photo.node.edge_media_to_caption.edges[0].node.text 
        : '';
      
      html += `
        <div class="instagram-photo">
          <a href="${postUrl}" target="_blank" rel="noopener">
            <img src="${imageUrl}" alt="${caption}" loading="lazy">
            <div class="instagram-photo-overlay">
              <span class="icon icon-instagram"></span>
            </div>
          </a>
        </div>
      `;
    });
    
    grid.innerHTML = html;
  }
  
  function renderInstagramPlaceholders(count, grid, loading, error) {
    loading.style.display = 'none';
    error.style.display = 'block';
    
    // Show placeholder grid
    let html = '';
    for (let i = 0; i < count; i++) {
      html += `
        <div class="instagram-photo">
          <div style="background: #f0f0f0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">
            <span class="icon icon-instagram"></span>
          </div>
        </div>
      `;
    }
    grid.innerHTML = html;
  }
  
  // Load Instagram feeds when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const instagramSections = document.querySelectorAll('[data-section-type="instagram"]');
    instagramSections.forEach(section => {
      const sectionId = section.getAttribute('data-section-id');
      if (sectionId) {
        loadInstagramFeed(sectionId);
      }
    });
  });
  
  function loadInstagramFeed(sectionId) {
    const grid = document.getElementById(`instagram-grid-${sectionId}`);
    const loading = document.getElementById(`instagram-loading-${sectionId}`);
    const error = document.getElementById(`instagram-error-${sectionId}`);
    
    if (!grid || !loading || !error) return;
    
    // Show loading
    loading.style.display = 'block';
    grid.style.display = 'none';
    error.style.display = 'none';
    
    // Use Instagram Basic Display API or fallback to embed
    const username = '{{ section.settings.instagram_username }}';
    const photoCount = {{ section.settings.photo_count | default: 6 }};
    const accessToken = '{{ settings.instagram_access_token }}';
    
    // Try different methods to get Instagram photos
    if (accessToken && accessToken.length > 10) {
      // Method 1: Use Instagram Basic Display API with token
      fetchInstagramWithToken(accessToken, photoCount, grid, loading, error);
    } else if (username) {
      // Method 2: Show placeholder with Instagram link
      showInstagramPlaceholder(username, photoCount, grid, loading, error);
    } else {
      showSetupInstructions(grid, loading, error);
    }
  }
  
  function fetchInstagramWithToken(token, count, grid, loading, error) {
    const apiUrl = `https://graph.instagram.com/me/media?fields=id,caption,media_url,permalink,thumbnail_url&limit=${count}&access_token=${token}`;
    
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        if (data.data && data.data.length > 0) {
          renderRealPhotos(data.data, grid, loading, error);
        } else {
          throw new Error('No photos found');
        }
      })
      .catch(err => {
        console.error('Token method failed:', err);
        // Fallback to embed method
        fetchInstagramOEmbed('{{ section.settings.instagram_username }}', count, grid, loading, error);
      });
  }
  
  function fetchInstagramOEmbed(username, count, grid, loading, error) {
    // Use Instafeed.js library approach (free, no token required)
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/gh/stevenschobert/instafeed.js@2.0.0/src/instafeed.min.js';
    script.onload = function() {
      if (window.Instafeed) {
        const feed = new Instafeed({
          accessToken: 'IGQVJYeUk2OGUzQVRQbWFKWk5hVl85ZA2xPRE5Ib2JsNFpZAY3d4ZAkRWVUtPdG9BdlJqcE9Gd1g1ckgtM3FhaXRqYW5nT3VoVE5VZAGRZAalBlcnNFQkdGMTRFRm5oUjFBZAkh3TjViOQ',
          template: '<div class="instagram-photo"><a href="{{link}}" target="_blank"><img src="{{image}}" alt="{{caption}}"/><div class="instagram-photo-overlay"><span class="icon icon-instagram"></span></div></a></div>',
          target: grid,
          limit: count,
          resolution: 'standard_resolution',
          after: function() {
            loading.style.display = 'none';
            grid.style.display = 'grid';
          },
          error: function() {
            console.error('Instafeed failed, using static display');
            showStaticInstagram(username, count, grid, loading, error);
          }
        });
        feed.run();
      } else {
        showStaticInstagram(username, count, grid, loading, error);
      }
    };
    script.onerror = function() {
      showStaticInstagram(username, count, grid, loading, error);
    };
    document.head.appendChild(script);
  }
  
  function renderRealPhotos(photos, grid, loading, error) {
    loading.style.display = 'none';
    error.style.display = 'none';
    grid.style.display = 'grid';
    
    let html = '';
    photos.forEach(photo => {
      const imageUrl = photo.thumbnail_url || photo.media_url;
      const caption = photo.caption || '';
      
      html += `
        <div class="instagram-photo">
          <a href="${photo.permalink}" target="_blank" rel="noopener">
            <img src="${imageUrl}" alt="${caption}" loading="lazy">
            <div class="instagram-photo-overlay">
              <span class="icon icon-instagram"></span>
            </div>
          </a>
        </div>
      `;
    });
    
    grid.innerHTML = html;
  }
  
  function showInstagramPlaceholder(username, count, grid, loading, error) {
    loading.style.display = 'none';
    error.style.display = 'none';
    grid.style.display = 'grid';
    
    let html = '';
    for (let i = 0; i < count; i++) {
      html += `
        <div class="instagram-photo">
          <a href="https://www.instagram.com/${username}" target="_blank" rel="noopener">
            <div style="width: 100%; height: 200px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
              ðŸ“·
            </div>
            <div class="instagram-photo-overlay">
              <span style="color: white;">@${username}</span>
            </div>
          </a>
        </div>
      `;
    }
    
    grid.innerHTML = html + '<p style="grid-column: 1/-1; text-align: center; margin-top: 1rem;"><strong>Add Instagram Access Token in Theme Settings â†’ API Integration to show real photos</strong></p>';
  }
  
  function showSetupInstructions(grid, loading, error) {
    loading.style.display = 'none';
    error.style.display = 'none';
    grid.style.display = 'block';
    
    grid.innerHTML = `
      <div style="text-align: center; padding: 2rem; border: 2px dashed #ccc; background: #f9f9f9;">
        <h3>Instagram Feed Setup</h3>
        <p>To display your Instagram photos:</p>
        <ol style="text-align: left; display: inline-block; max-width: 400px;">
          <li>Add your Instagram username in section settings</li>
          <li>Get an Instagram Access Token from Facebook Developers</li>
          <li>Add the token in <strong>Theme Settings â†’ API Integration</strong></li>
        </ol>
        <p><a href="https://developers.facebook.com/docs/instagram-basic-display-api" target="_blank">Get Instagram Access Token â†’</a></p>
      </div>
    `;
  }
</script>

{% schema %}
{
  "name": "Instagram Section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "FOLLOW US ON INSTAGRAM"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Section Subtitle",
      "default": "Stay connected with our latest updates and community highlights"
    },
    {
      "type": "header",
      "content": "Instagram Feed"
    },
    {
      "type": "text",
      "id": "instagram_username",
      "label": "Instagram Username",
      "info": "Enter your Instagram username (without @) to display photos",
      "placeholder": "godspeed_bikes"
    },
    {
      "type": "range",
      "id": "photo_count",
      "label": "Number of Photos",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "header",
      "content": "Alternative Options"
    },
    {
      "type": "html",
      "id": "instagram_embed_code",
      "label": "Instagram Embed Code",
      "info": "Paste Instagram embed code from instagram.com (most reliable method)"
    },
    {
      "type": "text",
      "id": "instagram_access_token",
      "label": "Instagram Access Token",
      "info": "Optional: Instagram Basic Display API token for showing actual photos"
    },
    {
      "type": "html",
      "id": "instafeed_code",
      "label": "Instafeed App Code",
      "info": "Paste the code from Instafeed app dashboard here"
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show Call to Action",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_title",
      "label": "CTA Title",
      "default": "Join Our Community"
    },
    {
      "type": "text",
      "id": "cta_description",
      "label": "CTA Description",
      "default": "Connect with fellow e-bike enthusiasts and stay updated with our latest products and news."
    },
    {
      "type": "text",
      "id": "cta_button_text",
      "label": "CTA Button Text",
      "default": "Get Started"
    },
    {
      "type": "url",
      "id": "cta_button_link",
      "label": "CTA Button Link"
    }
  ],
  "presets": [
    {
      "name": "Instagram Section",
      "category": "Social Media"
    }
  ]
}
{% endschema %}
