<section class="section-spacing" data-section-id="{{ section.id }}" data-section-type="featured-collections">
  <div class="page-width">
    <header class="section-header text-center">
      <h2 class="section-header__title">{{ section.settings.title | default: 'FEATURED COLLECTIONS' }}</h2>
    </header>
    
    <!-- Collection Category Tabs -->
    <div class="collection-tabs">
             <div class="tab-buttons">
         {% for block in section.blocks %}
           {% if block.type == 'collection_tab' %}
             {% assign collection = block.settings.collection %}
             {% if collection %}
               <button class="tab-button{% if forloop.first %} active{% endif %}" 
                       data-tab="{{ collection.handle }}">
                 {{ collection.title }}
               </button>
             {% endif %}
           {% endif %}
         {% endfor %}
       </div>
    </div>
    
    <!-- Collection Content -->
    {% for block in section.blocks %}
      {% if block.type == 'collection_tab' %}
        {% assign collection = block.settings.collection %}
        {% if collection %}
          <div class="collection-content{% if forloop.first %} active{% endif %}" 
               data-tab="{{ collection.handle }}">
            <div class="collection-grid">
              {% if collection.products.size > 0 %}
                {% for product in collection.products limit: section.settings.products_per_tab %}
                  <div class="collection-product">
                    <div class="product-image-wrapper">
                      <a href="{{ product.url }}" class="product-image-link">
                        <img src="{{ product.featured_image | img_url: '250x250', crop: 'center' }}" 
                             alt="{{ product.title | escape }}"
                             class="product-image"
                             loading="lazy">
                        {% unless product.available %}
                          <div class="sold-out-badge">SOLD OUT</div>
                        {% endunless %}
                      </a>
                      <div class="product-actions">
                        <button class="quick-view-btn" 
                                data-product-id="{{ product.id }}"
                                data-product-handle="{{ product.handle }}">
                          Quick View
                        </button>
                      </div>
                    </div>
                    <div class="product-info">
                      <h3 class="product-title h6">
                        <a href="{{ product.url }}">{{ product.title }}</a>
                      </h3>
                      <div class="product-price">
                        {% if product.compare_at_price > product.price %}
                          <span class="price-sale">{{ product.price | money }}</span>
                          <span class="price-compare">{{ product.compare_at_price | money }}</span>
                        {% else %}
                          <span class="price-regular">{{ product.price | money }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="no-products">
                  <p>No products found in this collection.</p>
                </div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <!-- No collection selected - show setup message -->
          <div class="collection-content{% if forloop.first %} active{% endif %}" 
               data-tab="setup-{{ forloop.index }}">
                       <div class="collection-setup">
             <h3>Collection Not Set</h3>
             <p>This collection tab doesn't have a collection selected.</p>
             <div class="setup-instructions">
               <p><strong>To fix this:</strong></p>
               <ol>
                 <li>Go to <strong>Online Store</strong> → <strong>Themes</strong> → <strong>Customize</strong></li>
                 <li>Find this "Featured Collections" section</li>
                 <li>Click on the "Collection Tab" block</li>
                 <li>Select a collection from the "Collection" dropdown</li>
                 <li>Save your changes</li>
               </ol>
             </div>
           </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
    
    <!-- No collections set at all -->
    {% assign has_collections = false %}
    {% for block in section.blocks %}
      {% if block.type == 'collection_tab' and block.settings.collection %}
        {% assign has_collections = true %}
        {% break %}
      {% endif %}
    {% endfor %}
    
    {% unless has_collections %}
             <div class="no-collections-setup">
         <h3>Featured Collections Setup</h3>
         <p>No collections have been selected for this section.</p>
         <div class="setup-instructions">
           <p><strong>To set up featured collections:</strong></p>
           <ol>
             <li>Go to <strong>Online Store</strong> → <strong>Themes</strong> → <strong>Customize</strong></li>
             <li>Find this "Featured Collections" section</li>
             <li>Click on each "Collection Tab" block</li>
             <li>Select collections from the "Collection" dropdowns</li>
             <li>Save your changes</li>
           </ol>
         </div>
       </div>
    {% endunless %}
  </div>
</section>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="quick-view-modal" style="display: none;">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="modal-close">&times;</button>
    <div class="quick-view-content">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const collectionContents = document.querySelectorAll('.collection-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        collectionContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        this.classList.add('active');
        const targetContent = document.querySelector(`[data-tab="${targetTab}"]`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
      });
    });
    
    // Quick view functionality
    const quickViewButtons = document.querySelectorAll('.quick-view-btn');
    const modal = document.getElementById('quick-view-modal');
    const modalContent = modal.querySelector('.quick-view-content');
    const modalClose = modal.querySelector('.modal-close');
    const modalOverlay = modal.querySelector('.modal-overlay');
    
    quickViewButtons.forEach(button => {
      button.addEventListener('click', function() {
        const productHandle = this.getAttribute('data-product-handle');
        loadQuickView(productHandle);
        modal.style.display = 'block';
      });
    });
    
    function closeModal() {
      modal.style.display = 'none';
    }
    
    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    
    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });
    
    function loadQuickView(productHandle) {
      // Load product data for quick view
      fetch(`/products/${productHandle}.js`)
        .then(response => response.json())
        .then(product => {
          modalContent.innerHTML = `
            <div class="quick-view-product">
              <div class="quick-view-image">
                <img src="${product.featured_image}" alt="${product.title}">
              </div>
              <div class="quick-view-details">
                <h3>${product.title}</h3>
                <p class="price">${formatMoney(product.price)}</p>
                <div class="description">${product.description.substring(0, 200)}...</div>
                <a href="/products/${product.handle}" class="btn btn--primary">View Full Product</a>
              </div>
            </div>
          `;
        })
        .catch(error => {
          modalContent.innerHTML = '<p>Error loading product details.</p>';
        });
    }
    
    function formatMoney(cents) {
      return '$' + (cents / 100).toFixed(2);
    }
  });
</script>

{% schema %}
{
  "name": "Featured Collections",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "FEATURED COLLECTIONS"
    },
    {
      "type": "range",
      "id": "products_per_tab",
      "label": "Products per tab",
      "min": 3,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "blocks": [
    {
      "type": "collection_tab",
      "name": "Collection Tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_title",
          "label": "Tab Title",
          "default": "FIRE"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Featured Collections",
      "category": "Content",
      "blocks": [
        {
          "type": "collection_tab",
          "settings": {
            "tab_title": "Electric Bikes"
          }
        },
        {
          "type": "collection_tab",
          "settings": {
            "tab_title": "Accessories"
          }
        },
        {
          "type": "collection_tab",
          "settings": {
            "tab_title": "Components"
          }
        }
      ]
    }
  ]
}
{% endschema %}
